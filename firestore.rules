
/**
 * # Core Philosophy
 * This ruleset enforces a strict user-ownership model for all personal data,
 * ensuring that users can only access their own information. Public content,
 * such as a central library of workouts and meals, is segregated into separate
 * top-level collections. This content is readable by any authenticated user,
 * but write access is disabled for all clients, pending a secure admin implementation.
 *
 * # Data Structure
 * - /users/{userId}: Stores private user profiles and serves as the root for all user-owned subcollections.
 *   - /users/{userId}/workoutProgress/{workoutProgressId}: Contains a user's private workout history.
 *   - /users/{userId}/mealPlans/{mealPlanId}: Contains a user's private meal plans.
 * - /workouts/{workoutId}: A read-only collection of available workouts, writable only by backend processes (e.g., an admin SDK).
 * - /meals/{mealId}: A read-only collection of available meals, writable only by backend processes (e.g., an admin SDK).
 * - /locations/{locationId}: A collection of user-submitted courts. Readable by all, writable by authenticated users for their own submissions.
 *
 * # Key Security Decisions
 * - **User Data Isolation**: All data under `/users/{userId}` is strictly controlled by path-based security, ensuring only the authenticated owner can access it.
 * - **No User Listing**: Listing the top-level `/users` collection is explicitly disallowed to protect user privacy.
 * - **Read-Only Public Content**: The `/workouts` and `/meals` collections are readable by any authenticated user to allow browsing of content. All client-side write operations are disabled.
 * - **Community-Sourced Locations**: Authenticated users can create new locations and can only modify or delete locations they created.
 * - **Default Deny**: Any operation not explicitly granted is denied.
 *
 * # Denormalization for Authorization
 * The data model is structured to make authorization simple and performant. By nesting user-specific data like `workoutProgress` under the user's document path `/users/{userId}`, we can write fast and simple ownership checks (`isOwner(userId)`) without needing any costly `get()` calls to other documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for readable and reusable logic
    function isSignedIn() {
      return request.auth != null;
    }

    // Checks if the requesting user's UID matches the document's owner ID.
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Checks if the requesting user has an 'admin' role in their user document.
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Ensures a document exists before an update or delete, and confirms ownership.
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    // Validates creation of a subcollection document, ensuring the internal userId field
    // matches the user path, establishing a clear ownership link.
    function isCreatingOwnedDocument(userId) {
      return isOwner(userId) && request.resource.data.userId == userId;
    }

    // Validates updates to a user's subcollection document.
    // Enforces immutability of the critical userId ownership link.
    function isUpdatingOwnedDocument(userId) {
      return isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
    }

    /**
     * @description Controls access to user profile documents and their private subcollections.
     * @path /users/{userId}
     * @principle Restricts all access to a user's own data tree. Admins have special privileges.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      
      // TEMPORARILY MODIFIED: Allow any signed-in user to create their own document.
      allow create: if isSignedIn() && request.resource.data.id == userId;
      
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();

      /**
       * @description Controls access to a user's private workout progress.
       * @path /users/{userId}/workoutProgress/{workoutProgressId}
       * @principle Enforces strict ownership for all operations.
       */
      match /workoutProgress/{workoutProgressId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isCreatingOwnedDocument(userId);
        allow update: if isUpdatingOwnedDocument(userId);
        allow delete: if isExistingOwner(userId);
      }

      /**
       * @description Controls access to a user's private meal plans.
       * @path /users/{userId}/mealPlans/{mealPlanId}
       * @principle Enforces strict ownership for all operations.
       */
      match /mealPlans/{mealPlanId} {
        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isCreatingOwnedDocument(userId);
        allow update: if isUpdatingOwnedDocument(userId);
        allow delete: if isExistingOwner(userId);
      }
    }

    /**
     * @description Controls access to the central, public collection of workouts.
     * @path /workouts/{workoutId}
     * @principle Provides read access for all signed-in users, but restricts all writes.
     *            Writes should be handled by a trusted backend with admin privileges.
     */
    match /workouts/{workoutId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create, update, delete: if isAdmin(); // Allow admins to manage workouts
    }

    /**
     * @description Controls access to the central, public collection of meals.
     * @path /meals/{mealId}
     * @principle Provides read access for all signed-in users, but restricts all writes.
     *            Writes should be handled by a trusted backend with admin privileges.
     */
    match /meals/{mealId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create, update, delete: if isAdmin(); // Allow admins to manage meals
    }

    /**
     * @description Controls access to the community-sourced collection of court locations.
     * @path /locations/{locationId}
     * @principle Allows any signed-in user to read. Allows users to create new locations
     *            and manage only the ones they've created.
     */
    match /locations/{locationId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.creatorId == request.auth.uid;
      allow update, delete: if isSignedIn() && resource.data.creatorId == request.auth.uid || isAdmin();
    }
  }
}

    